name: Generate Landing Product Pages

on:
  workflow_dispatch:
  schedule:
    - cron: "17 4 * * *"

permissions:
  contents: write

concurrency:
  group: landing-pages-generator
  cancel-in-progress: false

jobs:
  generate:
    runs-on: ubuntu-latest
    env:
      LANDING_PAGE_API_BASE_URL: ${{ secrets.LANDING_PAGE_API_BASE_URL }}
      LANDING_PAGE_TOKEN: ${{ secrets.LANDING_PAGE_TOKEN }}
      SITE_URL: ${{ vars.SITE_URL }}
      LANDING_PAGE_LIMIT: ${{ vars.LANDING_PAGE_LIMIT }}
      LANDING_PAGE_IMAGE_BASE_URL: ${{ vars.LANDING_PAGE_IMAGE_BASE_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Validate required secrets
        run: |
          if [ -z "$LANDING_PAGE_API_BASE_URL" ]; then
            echo "Missing secret LANDING_PAGE_API_BASE_URL"
            exit 1
          fi
          if [ -z "$LANDING_PAGE_TOKEN" ]; then
            echo "Missing secret LANDING_PAGE_TOKEN"
            exit 1
          fi

      - name: Generate landing pages from API
        run: |
          EFFECTIVE_SITE_URL="${SITE_URL:-https://discor.com.ar}"
          EFFECTIVE_LIMIT="${LANDING_PAGE_LIMIT:-100}"
          EFFECTIVE_IMAGE_BASE_URL="${LANDING_PAGE_IMAGE_BASE_URL:-https://imagenes.discor.com.ar}"

          node scripts/generate-landing-pages.mjs \
            --source api \
            --api-base-url "$LANDING_PAGE_API_BASE_URL" \
            --site-url "$EFFECTIVE_SITE_URL" \
            --image-base-url "$EFFECTIVE_IMAGE_BASE_URL" \
            --limit "$EFFECTIVE_LIMIT"

      - name: Commit and push generated pages
        run: |
          if [ -z "$(git status --porcelain products sitemap.xml robots.txt)" ]; then
            echo "No changes detected."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A products sitemap.xml robots.txt
          git commit -m "chore: regenerate landing pages"
          git push
